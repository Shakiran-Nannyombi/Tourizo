{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">

  <!-- Header -->
  <div class="d-flex align-items-center mb-4" style="border-bottom: 2px solid #a5c4a0; padding-bottom: 0.5rem;">
    <i class="fas fa-bookmark me-3" style="color: #3a5a40; font-size: 1.8rem;"></i>
    <div>
      <h3 style="color: #3a5a40; margin: 0;">My Bookings</h3>
      <small class="text-muted">Manage your upcoming experiences</small>
    </div>
  </div>

  {% if bookings %}
    <ul class="list-group" style="border-radius: 12px; overflow: hidden; border: 1px solid #e0e6dc;">
      {% for b in bookings %}
        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
            style="background-color: #f8fbf6; border-color: #e0e6dc;">

          <!-- Left side: Booking details -->
          <div class="mb-2" style="color: #3a5a40;">
            <strong><i class="fas fa-receipt"></i> Booking Ref:</strong> {{ b.reference }}<br>
            <strong><i class="fas fa-user"></i> Name:</strong> {{ b.full_name }}<br>

            {% set badge = 'success' if b.payment_status|lower == 'paid'
                          else 'danger' if b.payment_status|lower == 'cancelled'
                          else 'info' %}
            {% set badge_icon = 'fa-check-circle' if b.payment_status|lower == 'paid'
                               else 'fa-times-circle' if b.payment_status|lower == 'cancelled'
                               else 'fa-hourglass-half' %}
            <span class="badge bg-{{ badge }} text-white mb-2">
              <i class="fas {{ badge_icon }} me-1"></i> {{ b.payment_status|capitalize }}
            </span><br>

            <strong><i class="fas fa-users"></i> {{ b.num_people }} person(s)</strong> —
            <span class="text-success">{{ '{:,.0f}'.format(b.total_amount) }} UGX</span><br>

            {% if b.booking_date %}
              <strong><i class="fas fa-calendar-day"></i> Date:</strong> 
              <span class="text-primary">{{ b.booking_date }}
</span><br>
            {% endif %}
            {% if b.booking_time %}
              <strong><i class="fas fa-clock"></i> Time:</strong> 
              <span class="text-primary">{{ b.booking_time.strftime('%H:%M') }}</span><br>
            {% endif %}

            <!-- Debug status -->
            <small class="text-muted">Debug: <code>{{ b.payment_status }}</code></small>
          </div>

          <!-- Right side: Action buttons -->
          <div class="d-flex gap-2 flex-column flex-md-row">

            <!-- Edit -->
            <a href="{{ url_for('bookings.edit_booking', booking_id=b.id) }}"
               class="btn btn-sm"
               style="background-color: #a5c4a0; color: white; border: none;">
              <i class="fas fa-edit me-1"></i> Edit
            </a>

            <!-- Cancel -->
            {% if b.payment_status|lower != 'cancelled' %}
              <form method="post" action="{{ url_for('bookings.cancel', booking_id=b.id) }}"
                    onsubmit="return confirm('Are you sure you want to cancel this booking?');">
                {{ cancel_form.csrf_token }}
                <button class="btn btn-sm"
                        style="background-color: #d4a59a; color: white; border: none;"
                        type="submit">
                  <i class="fas fa-ban me-1"></i> Cancel
                </button>
              </form>
            {% endif %}

            <!-- Delete -->
            {% if b.payment_status|lower == 'cancelled' %}
              <form method="post" action="{{ url_for('bookings.delete_booking', booking_id=b.id) }}"
                    onsubmit="return confirm('Permanently delete this booking?');">
                {{ delete_form.csrf_token }}
                <button class="btn btn-sm"
                        style="background-color: #c97b63; color: white; border: none;"
                        type="submit">
                  <i class="fas fa-trash-alt me-1"></i> Delete
                </button>
              </form>
            {% endif %}

            <!-- Pay Now -->
            {% if b.payment_status|lower != 'paid' %}
              <button class="btn btn-sm btn-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#payModal"
                      data-booking-id="{{ b.id }}">
                <i class="fas fa-credit-card me-1"></i> Pay Now
              </button>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info text-center"
         style="background-color: #e8f4ea; border-color: #c8d5b9; color: #4a6b45;">
      <i class="fas fa-compass me-2"></i> No bookings found. Ready for your next adventure?
    </div>
  {% endif %}

  <<!-- Payment Modal -->
<div class="modal fade" id="payModal" tabindex="-1" aria-labelledby="payModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('bookings.pay') }}">
      {{ cancel_form.csrf_token }}  <!-- ✅ FIXED HERE -->
      <input type="hidden" name="booking_id" id="modal-booking-id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Complete Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="payment_method" class="form-label">Payment Method</label>
            <select class="form-select" name="payment_method" id="payment_method" required>
              <option value="">Select</option>
              <option value="momo">Mobile Money</option>
              <option value="card">Credit Card</option>
            </select>
          </div>

          <!-- MoMo -->
          <div class="mb-3 d-none" id="momo_fields">
            <label class="form-label">Mobile Money Number</label>
            <input type="text" class="form-control" name="momo_number" placeholder="+256..." />
          </div>

          <!-- Card -->
          <div class="mb-3 d-none" id="card_fields">
            <label class="form-label">Card Number</label>
            <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Pay</button>
        </div>
      </div>
    </form>
  </div>
</div>

</div>

<!-- JS for Payment Modal -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('payModal');
    const bookingIdInput = modal.querySelector('#modal-booking-id');
    const methodSelect = modal.querySelector('#payment_method');
    const momoFields = modal.querySelector('#momo_fields');
    const cardFields = modal.querySelector('#card_fields');

    // Reset modal every time it is shown
    modal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const bookingId = button.getAttribute('data-booking-id');
      bookingIdInput.value = bookingId;

      // Reset payment fields
      methodSelect.value = '';
      momoFields.classList.add('d-none');
      cardFields.classList.add('d-none');
    });

    // Show relevant fields
    methodSelect.addEventListener('change', () => {
      momoFields.classList.add('d-none');
      cardFields.classList.add('d-none');
      if (methodSelect.value === 'momo') {
        momoFields.classList.remove('d-none');
      } else if (methodSelect.value === 'card') {
        cardFields.classList.remove('d-none');
      }
    });
  });
</script>


<!-- FontAwesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
{% endblock %}
