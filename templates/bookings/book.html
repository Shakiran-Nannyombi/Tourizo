<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Tour</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f9f4;
            font-family: 'Segoe UI', sans-serif;
        }

        h1,
        h3,
        h5 {
            color: #2c5f2d;
        }

        .booking-section {
            border: 1px solid #cfe0c3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(46, 125, 50, 0.1);
        }

        #total-price {
            font-weight: bold;
            color: #4CAF50;
        }

        .payment-details {
            border: 1px solid #dcedc8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            background-color: #f1f8e9;
        }

        .form-control:focus {
            border-color: #81c784;
            box-shadow: 0 0 0 0.2rem rgba(129, 199, 132, 0.25);
        }

        .btn-primary {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }

        .btn-primary:hover {
            background-color: #388e3c;
            border-color: #388e3c;
        }

        .payment-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .spinner-border {
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">Book Tour</h1>

        <div class="text-center mb-4">
            <img src="https://source.unsplash.com/1200x300/?safari,wildlife" alt="Safari Banner"
                class="img-fluid rounded shadow-sm">
        </div>

        <form id="bookingForm" method="POST" action="{{ url_for('book') }}" class="mb-4">
            {{ form.hidden_tag() }}

            <div class="booking-section">
                <h3>Personal Information</h3>

                <div class="mb-3">
                    {{ form.full_name.label(class="form-label") }}
                    {{ form.full_name(class="form-control", placeholder="Your full name") }}
                    {% for error in form.full_name.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control", placeholder="example@domain.com") }}
                    {% for error in form.email.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.phone.label(class="form-label") }}
                    {{ form.phone(class="form-control", placeholder="+256 XXX XXX XXX") }}
                    {% for error in form.phone.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.num_people.label(class="form-label") }}
                    {{ form.num_people(class="form-control", min=1, id="num_people") }}
                    {% for error in form.num_people.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.tour_id.label(class="form-label") }}
                    {{ form.tour_id(class="form-select", id="tour_id") }}
                    {% for error in form.tour_id.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.booking_date.label(class="form-label") }}
                    {{ form.booking_date(class="form-control") }}
                    {% for error in form.booking_date.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {{ form.booking_time.label(class="form-label") }}
                    {{ form.booking_time(class="form-control") }}
                    {% for error in form.booking_time.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    <p>Total Price: <strong><span id="total-price">0.00</span> UGX</strong></p>
                </div>
            </div>

            <div class="booking-section">
                <h3>Payment Method</h3>

                <div class="mb-3">
                    {{ form.payment_method.label(class="form-label") }}
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="momo" value="momo"
                                checked>
                            <label class="form-check-label d-flex align-items-center" for="momo">
                                <img src="https://cdn-icons-png.flaticon.com/512/179/179457.png" alt="Mobile Money"
                                    class="payment-icon">
                                Mobile Money
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="card" value="card">
                            <label class="form-check-label d-flex align-items-center" for="card">
                                <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Credit Card"
                                    class="payment-icon">
                                Credit/Debit Card
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="bank" value="bank">
                            <label class="form-check-label d-flex align-items-center" for="bank">
                                <img src="https://cdn-icons-png.flaticon.com/512/2830/2830280.png" alt="Bank Transfer"
                                    class="payment-icon">
                                Bank Transfer
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Mobile Money Details -->
                <div class="payment-details" id="momo-details">
                    <h5>Mobile Money Details</h5>
                    <div class="mb-3">
                        <label for="momo_provider" class="form-label">Provider</label>
                        <select class="form-select" name="momo_provider" id="momo_provider" required>
                            <option value="">Select provider</option>
                            <option value="MTN">MTN Mobile Money</option>
                            <option value="Airtel">Airtel Money</option>
                            <option value="Africell">Africell Money</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="momo_number" class="form-label">Mobile Number</label>
                        <input type="tel" class="form-control" name="momo_number" id="momo_number"
                            placeholder="+2567XXXXXXXX" required>
                    </div>
                    <div class="mb-3">
                        <label for="momo_name" class="form-label">Account Holder Name</label>
                        <input type="text" class="form-control" name="momo_name" id="momo_name" required>
                    </div>
                </div>

                <!-- Card Details -->
                <div class="payment-details d-none" id="card-details">
                    <h5>Card Payment Details</h5>
                    <div class="mb-3">
                        <label for="card_number" class="form-label">Card Number</label>
                        <input type="text" class="form-control" name="card_number" id="card_number"
                            placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="card_expiry" class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" name="card_expiry" id="card_expiry"
                                placeholder="MM/YY" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="card_cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" name="card_cvv" id="card_cvv" placeholder="123"
                                required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="card_name" class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control" name="card_name" id="card_name" required>
                    </div>
                </div>

                <!-- Bank Details -->
                <div class="payment-details d-none" id="bank-details">
                    <h5>Bank Transfer Details</h5>
                    <div class="mb-3">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <select class="form-select" name="bank_name" id="bank_name" required>
                            <option value="">Select bank</option>
                            <option value="Stanbic Bank">Stanbic Bank</option>
                            <option value="Centenary Bank">Centenary Bank</option>
                            <option value="DFCU Bank">DFCU Bank</option>
                            <option value="Standard Chartered">Standard Chartered</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="account_number" class="form-label">Account Number</label>
                        <input type="text" class="form-control" name="account_number" id="account_number" required>
                    </div>
                    <div class="mb-3">
                        <label for="account_name" class="form-label">Account Holder Name</label>
                        <input type="text" class="form-control" name="account_name" id="account_name" required>
                    </div>
                    <div class="alert alert-info">
                        <small>Please use your booking ID as the reference when making the transfer.</small>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                {{ form.special_requests.label(class="form-label") }}
                {{ form.special_requests(class="form-control", placeholder="Any special requests or notes...", rows="3")
                }}
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="terms" required>
                <label class="form-check-label" for="terms">
                    I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and
                        conditions</a>
                </label>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary w-100 py-2" id="submitBtn">
                    <span id="submitText">Book Now & Pay</span>
                    <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                        aria-hidden="true"></span>
                </button>
            </div>

            <div id="formMessages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>
        </form>

        <a href="{{ url_for('my_bookings') }}" class="btn btn-outline-secondary">My bookings</a>
    </div>

    <!-- Terms Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Booking Policy</h6>
                    <p>All bookings require full payment to confirm your reservation. Prices are subject to change
                        without notice until the booking is confirmed.</p>

                    <h6>Cancellation Policy</h6>
                    <p>Cancellations made more than 14 days prior to the tour date will receive a full refund.
                        Cancellations made 7-14 days prior will receive a 50% refund. No refunds for cancellations
                        within 7 days of the tour.</p>

                    <h6>Payment Security</h6>
                    <p>All payments are processed securely. We do not store your credit card details.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize tour prices
        const tourPrices = {{ tour_prices | tojson | safe }};

        // DOM elements
        const tourSelect = document.getElementById("tour_id");
        const numPeopleInput = document.getElementById("num_people");
        const totalPriceEl = document.getElementById("total-price");
        const submitBtn = document.getElementById("submitBtn");
        const submitText = document.getElementById("submitText");
        const submitSpinner = document.getElementById("submitSpinner");

        // Update total price calculation
        function updateTotal() {
            if (!tourSelect || !numPeopleInput || !totalPriceEl) return;

            const tourId = parseInt(tourSelect.value);
            const numPeople = parseInt(numPeopleInput.value) || 1;
            const price = tourPrices[tourId] || 0;
            const total = price * numPeople;

            totalPriceEl.textContent = total.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Toggle payment details based on selected method
        function togglePaymentDetails() {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            const momoDetails = document.getElementById('momo-details');
            const cardDetails = document.getElementById('card-details');
            const bankDetails = document.getElementById('bank-details');

            // Hide all first
            [momoDetails, cardDetails, bankDetails].forEach(el => {
                if (el) el.classList.add('d-none');
            });

            // Clear required attributes
            document.querySelectorAll('[id$="-details"] input, [id$="-details"] select').forEach(el => {
                el.removeAttribute('required');
            });

            // Show selected and set required fields
            switch (selectedMethod) {
                case 'momo':
                    if (momoDetails) {
                        momoDetails.classList.remove('d-none');
                        document.getElementById('momo_provider')?.setAttribute('required', '');
                        document.getElementById('momo_number')?.setAttribute('required', '');
                        document.getElementById('momo_name')?.setAttribute('required', '');
                    }
                    break;
                case 'card':
                    if (cardDetails) {
                        cardDetails.classList.remove('d-none');
                        document.getElementById('card_number')?.setAttribute('required', '');
                        document.getElementById('card_expiry')?.setAttribute('required', '');
                        document.getElementById('card_cvv')?.setAttribute('required', '');
                        document.getElementById('card_name')?.setAttribute('required', '');
                    }
                    break;
                case 'bank':
                    if (bankDetails) {
                        bankDetails.classList.remove('d-none');
                        document.getElementById('bank_name')?.setAttribute('required', '');
                        document.getElementById('account_number')?.setAttribute('required', '');
                        document.getElementById('account_name')?.setAttribute('required', '');
                    }
                    break;
            }
        }

        // Format card inputs
        function formatCardNumber(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
            e.target.value = formattedValue.substring(0, 19);
        }

        function formatExpiryDate(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value.substring(0, 5);
        }

        function restrictToNumbers(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        }

        // Form submission handler
        function handleFormSubmit(e) {
            // Show loading state
            submitText.classList.add('d-none');
            submitSpinner.classList.remove('d-none');
            submitBtn.disabled = true;

            // You might want to add additional validation here
            // If using AJAX, prevent default and handle submission
            // Otherwise, let the form submit normally
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Set up event listeners for price calculation
            if (tourSelect) tourSelect.addEventListener('change', updateTotal);
            if (numPeopleInput) numPeopleInput.addEventListener('input', updateTotal);

            // Set up payment method toggling
            document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
                radio.addEventListener('change', togglePaymentDetails);
            });

            // Set up card input formatting
            const cardNumberInput = document.getElementById('card_number');
            const cardExpiryInput = document.getElementById('card_expiry');
            const cardCvvInput = document.getElementById('card_cvv');

            if (cardNumberInput) cardNumberInput.addEventListener('input', formatCardNumber);
            if (cardExpiryInput) cardExpiryInput.addEventListener('input', formatExpiryDate);
            if (cardCvvInput) cardCvvInput.addEventListener('input', restrictToNumbers);

            // Set up form submission
            const form = document.getElementById('bookingForm');
            if (form) form.addEventListener('submit', handleFormSubmit);

            // Initial calculations and setup
            updateTotal();
            togglePaymentDetails();
        });
    </script>
</body>

</html>